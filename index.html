<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weekly Daily Check</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #f8f9fa; font-weight: 600; }
        .task-name { text-align: left; width: 40%; font-weight: 500; }
        input[type="checkbox"] { transform: scale(1.5); cursor: pointer; }
        .week-header { display: flex; justify-content: space-between; align-items: center; }
        tr:hover { background-color: #f1f8ff; }
    </style>
</head>
<body>

<div class="card">
    <div class="week-header">
        <h2>Weekly Maintenance Check</h2>
        <input type="file" id="csvFile" accept=".csv">
    </div>
    
    <table id="checklistTable">
        <thead>
            <tr>
                <th class="task-name">Task Description</th>
                <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { /* PASTE YOUR CONFIG HERE */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Identify current week (e.g., "2026_W08")
    const now = new Date();
    const weekId = `${now.getFullYear()}_W${getWeekNumber(now)}`;
    const docRef = doc(db, "weekly_checks", weekId);

    const tableBody = document.getElementById('tableBody');

    // 1. Handle File Upload
    document.getElementById('csvFile').addEventListener('change', function(e) {
        if (!e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const tasks = event.target.result.split('\n')
                .map(t => t.trim())
                .filter(t => t && !t.includes('http') && t.length > 3);
            renderTable(tasks);
        };
        reader.readAsText(e.target.files[0]);
    });

    // 2. Build the Grid
    function renderTable(tasks) {
        tableBody.innerHTML = '';
        tasks.forEach((task, index) => {
            const row = document.createElement('tr');
            let html = `<td class="task-name">${task}</td>`;
            
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].forEach(day => {
                const cellId = `task${index}_${day}`;
                html += `<td><input type="checkbox" id="${cellId}" data-task="${task}" data-day="${day}"></td>`;
            });
            
            row.innerHTML = html;
            tableBody.appendChild(row);
        });

        setupSync();
    }

    // 3. Real-time Sync with Firebase
    function setupSync() {
        // Listen for changes from Database
        onSnapshot(docRef, (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.data();
                Object.keys(data).forEach(cellId => {
                    const el = document.getElementById(cellId);
                    if (el) el.checked = data[cellId];
                });
            }
        });

        // Save changes to Database
        tableBody.addEventListener('click', async (e) => {
            if (e.target.type === 'checkbox') {
                const update = {};
                update[e.target.id] = e.target.checked;
                await setDoc(docRef, update, { merge: true });
            }
        });
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
</script>
</body>
</html>
