<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Check-In</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .completed { text-decoration: line-through; color: gray; }
    </style>
</head>
<body>

<div class="container">
    <h2>Daily Checklist</h2>
    <input type="file" id="csvFile" accept=".csv" />
    <p><small>Export your Excel template as CSV and upload it here.</small></p>
    <hr>
    <div id="checklist"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // TODO: Replace with YOUR Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAYeIrEFJ0AIK2EScA91lPQXtqf-lOfBWk",
  authDomain: "aquadailychecks.firebaseapp.com",
  projectId: "aquadailychecks",
  storageBucket: "aquadailychecks.firebasestorage.app",
  messagingSenderId: "1088043283120",
  appId: "1:1088043283120:web:d23dedd97b07c041e7c175",
  measurementId: "G-BM64K8XYV0"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
const checklistDiv = document.getElementById('checklist');
  const today = new Date().toISOString().split('T')[0];

  document.getElementById('csvFile').addEventListener('change', function(e) {
    // FIX: Check if a file was actually selected
    if (!e.target.files || e.target.files.length === 0) return;

    const reader = new FileReader();
    reader.onload = function() {
      const lines = reader.result.split('\n')
        .map(line => line.trim())
        // FIX: Ignore empty lines or lines containing URLs/Paths
        .filter(line => line && !line.includes('http') && !line.startsWith(','));
      
      renderChecklist(lines);
    };
    reader.readAsText(e.target.files[0]);
  });

  async function renderChecklist(tasks) {
    checklistDiv.innerHTML = 'Loading tasks...';
    const fragment = document.createDocumentFragment();

    for (const taskName of tasks) {
      // FIX: Sanitize the Document ID (Remove / . # $ [ ])
      const safeId = taskName.replace(/[\/.\#$\[\]]/g, '_').substring(0, 100);
      const docId = `${today}_${safeId}`;
      
      const docRef = doc(db, "daily_checks", docId);
      const docSnap = await getDoc(docRef);
      
      let isChecked = docSnap.exists() ? docSnap.data().status : false;

      const item = document.createElement('div');
      item.className = 'task-item';
      item.innerHTML = `
        <span class="${isChecked ? 'completed' : ''}">${taskName}</span>
        <input type="checkbox" ${isChecked ? 'checked' : ''}>
      `;

      const checkbox = item.querySelector('input');
      checkbox.onclick = async () => {
        try {
            await setDoc(docRef, { taskName, status: checkbox.checked, date: today });
            item.querySelector('span').className = checkbox.checked ? 'completed' : '';
        } catch (err) {
            console.error("Firebase Save Error:", err);
            alert("Could not save status. Check console.");
        }
      };

      fragment.appendChild(item);
    }
    checklistDiv.innerHTML = '';
    checklistDiv.appendChild(fragment);
  }
</script>
</body>
</html>
